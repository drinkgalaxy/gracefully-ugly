<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gracefullyugly.domain.cart.repository.CartMapper">
    <resultMap id="Item" type="com.gracefullyugly.domain.item.entity.Item">
        <id column="item_id" property="itemId"/>
        <result column="user_id" property="userId"/>
        <result column="type_id" property="categoryId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="price" property="price"/>
        <result column="total_sales_unit" property="totalSalesUnit"/>
        <result column="min_unit_weight" property="minUnitWeight"/>
        <result column="min_group_buy_weight" property="minGroupBuyWeight"/>
        <result column="production_place" property="productionPlace"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="is_closed" property="isClosed"/>
    </resultMap>

    <resultMap id="cartListItem" type="com.gracefullyugly.domain.cart.dto.CartListResponse">
        <result column="item_count" property="itemCount"/>
        <association property="cartListItem" resultMap="Item"/>
    </resultMap>

    <insert id="createNewCart" parameterType="Long" flushCache="true" useGeneratedKeys="true" keyProperty="cart_id">
        INSERT INTO cart(`user_id`, `created_date`, `last_modified_date`)
        SELECT user_id, NOW(), NOW()
        FROM users
        WHERE user_id = #{userId};
    </insert>

    <select id="selectCartByUserId" parameterType="Long" resultType="com.gracefullyugly.domain.cart.entity.Cart">
        SELECT *
        FROM cart
        WHERE user_id = #{userId};
    </select>
    
    <select id="selectAllCartItems" parameterType="Long" resultMap="cartListItem">
        SELECT CI.item_count, I.*
        FROM cart AS C
        LEFT OUTER JOIN cart_item AS CI ON C.cart_id = CI.cart_id
        LEFT OUTER JOIN item AS I ON CI.item_id = I.item_id
        WHERE C.user_id = #{userId};
    </select>
</mapper>